## 让用户不在匿名

### 添加登录页面

简单起见，我们要求用户使用gmail登录，通过gmail可以拿到用户的avatar头像。在此之前我们先对前端代码进行了一下重构，从technode.js中，将组件拆了出来，便于代码维护。

拆了之后前端的结构如下：

```
static
├── components
│   ├── angular
│   ├── bootstrap
│   └── jquery
├── controllers
│   ├── message-creator.js
│   └── room.js
├── directives
│   ├── auto-scroll-to-bottom.js
│   └── ctrl-enter-break-line.js
├── index.html
├── services
│   └── socket.js
├── styles
│   └── room.css
└── technode.js
```

接下来，我们使用angular的router组件，将app分成两个页面：

- `/` 聊天室
- `/login` 登录页，让用户输入gmail登录

首先，安装angular-router：

```
bower install angular-route --save 
```

在index.html中引入angular-route：

```
<script type="text/javascript" src="/components/angular/angular.js"></script>
<script type="text/javascript" src="/components/angular-route/angular-route.js"></script>
```

在technode.js中添加对angular-route的依赖，引入router组件：

```
angular.module('techNodeApp', ['ngRoute'])
```

新建router.js，声明对router的处理：

```
angular.module('techNodeApp').config(function($routeProvider, $locationProvider) {
  $locationProvider.html5Mode(true);
  $routeProvider.
  when('/', {
    templateUrl: '/pages/room.html',
    controller: 'RoomCtrl'
  }).
  when('/login', {
    templateUrl: '/pages/login.html',
    controller: 'LoginCtrl'
  }).
  otherwise({
    redirectTo: '/login'
  })
})
```

我们采用html5的pushState来实现路由机制；接下来我们需要把room项目的html从index.html拆出来放到room.html中，供angular调用；

```
<div class="col-md-12">
  <div class="panel panel-default room">
    <div class="panel-heading room-header">TechNode</div>
    <div class="panel-body room-content">
      <div class="list-group messages" auto-scroll-to-bottom>
        <div class="list-group-item message" ng-repeat="message in messages">
          某某: {{message}}
        </div>
      </div>
      <form class="message-creator" ng-controller="MessageCreatorCtrl">
        <div class="form-group">
          <textarea required class="form-control message-input" ng-model="newMessage" ctrl-enter-break-line="createMessage()" placeholder="Ctrl+Enter to quick send"></textarea>
        </div>
      </form>
    </div>
  </div>
</div>
```

在index.html中，放一个占位，angular会更具url的不同载入不同的page，使用不同的controller；

```
<div class="container" style="margin-top:100px;">
  <div class="row" ng-view>
</div>
```

接下来，加入login.html，开始设计TechNode的登陆页吧！

```
<form class="form-inline">
  <div class="form-group">
    <label class="sr-only">Gmail</label>
    <input type="email" required class="form-control" placeholder="Gmail Account" />
  </div>
  <button type="submit" class="btn btn-primary btn-enter">Enter</button>
</form>
```

这个页面非常简单，就是一个表单，让用户提交gmail账号；

### 用户登录与认证

因为我们是一个单页面的应用程序，因此我们使用Ajax来实现用户登录和认证；首先添加一个全局的controller MainCtrl，用于用户是否登录的检测，如果未登录则跳转至登陆页。

index.html

```
<body ng-controller="MainCtrl">
  ...
</body>
```

/controllers/main.js

```
angular.module('techNodeApp').controller('MainCtrl', function($scope, $http, $location) {
  $http({
    url: '/ajax/validate',
    method: 'GET'
  }).success(function (user) {

  }).error(function (data) {
    $location.path('/login')
  })
})
```

通过ajax获取用户的信息，如果没有获取到，就意味着用户还没有登录，打开登录页面；来看看服务端怎么实现。

为了便于实现，我们在服务端采用mongodb来存储登录用户的信息；我们使用mongoose来操作mongodb，首先定义user的scheme：

新建models文件夹，创建user.js和index.js文件：

user.js:

```
var mongoose = require('mongoose')
var Schema = mongoose.Schema

var User = new Schema({
  email: String,
  name: String,
  avatar: String
});

module.exports = User
```

用户输入email，我们通过解析用户的email获取name和avatar头像地址；再来看看index.js文件：

```
var mongoose = require('mongoose')
mongoose.connect('mongodb://localhost/technodechapter02')
exports.User = mongoose.model('User', require('./user'))
```

我们使用mongoose来访问mongodb，使用user的scheme生成模型User，记得使用`npm install mongoose --save`安装mongoose；

接下来我们就要编写验证的逻辑了，新建controllers文件夹，新建user.js文件，为了便于管理代码，我们把user的业务逻辑都放在controller/user.js这个文件中；





